# docker-compose.acceptance.yml - 인수 테스트 환경
# Usage: docker-compose -f docker-compose.acceptance.yml up --build
#
# 용도:
# - 자동화된 인수/E2E 테스트 환경 구성
# - Spring Boot 서비스 빌드 및 실행
# - 휘발성 볼륨 사용 (테스트 후 삭제 권장)
#
# 환경변수:
# - .env (docker-compose 공통)
# - .env.common (앱 컨테이너 기본값)
# - .env.acceptance (acceptance 오버라이드)
#
# 정리:
# - docker-compose -f docker-compose.acceptance.yml down -v

services:
  # LocalStack - AWS 서비스 로컬 에뮬레이션 (테스트용)
  localstack:
    image: localstack/localstack-pro
    container_name: unisync-acceptance-localstack
    ports:
      - "4566:4566"
    env_file:
      - .env.local  # 로컬 종속 비밀 (LOCALSTACK_AUTH_TOKEN 등)
      - .env.common  # Lambda가 사용할 공통 설정 (CANVAS_API_BASE_URL, USER_SERVICE_URL 등)
      - .env.acceptance
    environment:
      - SERVICES=sqs,lambda,cognito-idp,iam
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - LAMBDA_EXECUTOR=docker-reuse
    volumes:
      - ".:/workspace"
      - "./localstack-init:/etc/localstack/init/ready.d"
      - "./app/serverless:/var/lib/localstack/serverless"
      - "/var/run/docker.sock:/var/run/docker.sock"
    tmpfs:
      - /var/lib/localstack  # 익명 볼륨 대신 tmpfs 사용
    networks:
      - acceptance-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 10

  # MySQL - 테스트용 휘발성 DB
  mysql:
    image: mysql:8.0
    container_name: unisync-acceptance-mysql
    ports:
      - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - TZ=Asia/Seoul
    volumes:
      - ./mysql-init:/docker-entrypoint-initdb.d
    tmpfs:
      - /var/lib/mysql  # 익명 볼륨 대신 tmpfs 사용
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - acceptance-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 10

  # User Service - 인증 및 Canvas 토큰 관리
  user-service:
    build:
      context: ./app
      dockerfile: backend/user-service/Dockerfile
    container_name: unisync-acceptance-user-service
    ports:
      - "8081:8081"
    env_file:
      - .env.local      # 비밀 (COGNITO_USER_POOL_ID 등)
      - .env.common     # 공통 설정
      - .env.acceptance # acceptance 오버라이드
    environment:
      - SPRING_PROFILES_ACTIVE=acceptance
    depends_on:
      mysql:
        condition: service_healthy
      localstack:
        condition: service_healthy
    networks:
      - acceptance-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  # Course Service - 과목 및 과제 관리
  course-service:
    build:
      context: ./app
      dockerfile: backend/course-service/Dockerfile
    container_name: unisync-acceptance-course-service
    ports:
      - "8082:8082"
    env_file:
      - .env.local      # 비밀 (COGNITO_USER_POOL_ID 등)
      - .env.common     # 공통 설정
      - .env.acceptance # acceptance 오버라이드
    environment:
      - SPRING_PROFILES_ACTIVE=acceptance
    depends_on:
      mysql:
        condition: service_healthy
      localstack:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - acceptance-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  # Schedule Service - 일정 및 할일 관리
  schedule-service:
    build:
      context: ./app
      dockerfile: backend/schedule-service/Dockerfile
    container_name: unisync-acceptance-schedule-service
    ports:
      - "8083:8083"
    env_file:
      - .env.local      # 비밀 (COGNITO_USER_POOL_ID 등)
      - .env.common     # 공통 설정
      - .env.acceptance # acceptance 오버라이드
    environment:
      - SPRING_PROFILES_ACTIVE=acceptance
    depends_on:
      mysql:
        condition: service_healthy
      localstack:
        condition: service_healthy
      user-service:
        condition: service_healthy
      course-service:
        condition: service_healthy
    networks:
      - acceptance-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  # API Gateway - 모든 요청의 진입점
  api-gateway:
    build:
      context: ./app
      dockerfile: backend/api-gateway/Dockerfile
    container_name: unisync-acceptance-api-gateway
    ports:
      - "8080:8080"
    env_file:
      - .env.local      # 비밀 (COGNITO_USER_POOL_ID 등)
      - .env.common     # 공통 설정
      - .env.acceptance # acceptance 오버라이드
    environment:
      - SPRING_PROFILES_ACTIVE=acceptance
    depends_on:
      user-service:
        condition: service_healthy
      course-service:
        condition: service_healthy
      schedule-service:
        condition: service_healthy
    networks:
      - acceptance-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

networks:
  acceptance-network:
    driver: bridge
