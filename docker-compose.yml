# docker-compose.yml - 기본 인프라 환경
# Usage: docker-compose up
#
# 용도:
# - 로컬 개발 시 필요한 인프라 서비스 (MySQL, LocalStack) 제공
# - Spring Boot 서비스는 IDE에서 직접 실행
# - docker-compose.override.yml로 개인화 가능 (.gitignore)
#
# 환경변수:
# - .env 파일 자동 로드 (비밀 없는 기본값)
# - .env.local 파일 env_file로 로드 (로컬 종속 비밀)

services:
  # ==========================================
  # Infrastructure Services
  # ==========================================

  # LocalStack - AWS 서비스 로컬 에뮬레이션
  localstack:
    image: localstack/localstack-pro
    container_name: unisync-localstack
    env_file:
      - .env.local  # 로컬 종속 비밀 (LOCALSTACK_AUTH_TOKEN 등)
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    environment:
      - SERVICES=sqs,stepfunctions,lambda,s3,secretsmanager,events,cognito-idp,elasticloadbalancingv2,ec2
      - DEBUG=1
      - PERSISTENCE=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - LAMBDA_EXECUTOR=docker-reuse
      - LAMBDA_RUNTIME_ENVIRONMENT_TIMEOUT=30
    volumes:
      - ".:/workspace"  # 프로젝트 루트 마운트 (스크립트가 .env.local 파일 업데이트 가능)
      - "./localstack-init:/etc/localstack/init/ready.d"
      - "./app/serverless:/var/lib/localstack/serverless"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "localstack-data:/var/lib/localstack"
    networks:
      - unisync-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MySQL - 각 서비스별 데이터베이스
  mysql:
    image: mysql:8.0
    container_name: unisync-mysql
    ports:
      - "3307:3306"  # 호스트 포트 변경 (호스트 3306 충돌 방지)
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - TZ=Asia/Seoul
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - unisync-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mysql-data:
    driver: local
  localstack-data:
    driver: local

networks:
  unisync-network:
    driver: bridge
